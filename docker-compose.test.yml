# Docker Compose for FastAPI Testing
# Runs tests with connection pooling configuration

version: '3.8'

services:
  # Test database
  postgres-test:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: solar_intelligence_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      # PostgreSQL Performance Tuning (test optimized)
      POSTGRES_MAX_CONNECTIONS: 100
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 256MB
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d solar_intelligence_test"]
      interval: 5s
      timeout: 3s
      retries: 5
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=128MB
      -c effective_cache_size=256MB
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c random_page_cost=1.1

  # FastAPI test runner
  fastapi-test:
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    environment:
      - FASTAPI_DATABASE_URL=postgresql+asyncpg://test_user:test_password@postgres-test:5432/solar_intelligence_test
      - FLASK_ENV=development
      - FLASK_SECRET_KEY=test-secret-key
      - OPENAI_API_KEY=${OPENAI_API_KEY:-test-key}
      # Connection Pool Settings for Testing
      - DB_POOL_SIZE=10
      - DB_MAX_OVERFLOW=20
      - DB_POOL_TIMEOUT=30
      - DB_POOL_RECYCLE=3600
      - DB_POOL_PRE_PING=True
      - DB_ECHO_POOL=False
      - DB_CONNECT_TIMEOUT=10
      - DB_COMMAND_TIMEOUT=60
    volumes:
      - ./fastapi_app:/app/fastapi_app
      - ./tests_output:/app/tests_output
    depends_on:
      postgres-test:
        condition: service_healthy
    command: >
      bash -c "
      echo 'ðŸ§ª Installing pytest dependencies...' &&
      poetry add pytest pytest-asyncio httpx --dev --no-interaction &&
      echo 'âœ… Dependencies installed' &&
      echo 'ðŸ§ª Running FastAPI tests with connection pooling...' &&
      pytest fastapi_app/tests/ -v --tb=short --color=yes &&
      echo 'âœ… All tests passed!'
      "

volumes:
  tests_output:
    driver: local
